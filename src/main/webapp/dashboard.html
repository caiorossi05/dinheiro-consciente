<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Dinheiro Consciente</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-content {
            max-width: 900px;
            margin: 30px auto;
            background: #fff;
            padding: 25px 30px;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.08);
        }

        .dashboard-header h1 {
            margin-bottom: 5px;
        }

        .dashboard-header p {
            margin-top: 0;
        }

        .logout-link {
            margin-top: 10px;
        }

        .cards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .card {
            flex: 1 1 180px;
            border-radius: 8px;
            padding: 15px 20px;
            background: #f5f5f5;
        }

        .card h3 {
            margin: 0 0 8px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .card .valor {
            font-size: 1.4rem;
            font-weight: bold;
        }

        .card.receita { border-left: 4px solid #00796b; }
        .card.despesa { border-left: 4px solid #d32f2f; }
        .card.saldo   { border-left: 4px solid #3f51b5; }

        .secao {
            margin-top: 25px;
        }

        .secao h2 {
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .tabela-transacoes {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .tabela-transacoes th,
        .tabela-transacoes td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 0.9rem;
        }

        .tabela-transacoes th {
            background-color: #00796b;
            color: #fff;
        }

        .tabela-transacoes tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .receita-texto { color: #00796b; font-weight: bold; }
        .despesa-texto { color: #d32f2f; font-weight: bold; }

        #insightTexto {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>

<div class="dashboard-content">

    <div class="dashboard-header">
        <h1>Bem-vindo ao Dinheiro Consciente!</h1>
        <p>Olá, <strong id="nomeUsuario">Usuário</strong>.</p>
        <p class="logout-link">
            <a href="usuario?acao=sair">Sair</a>
        </p>
    </div>

    <hr>

    <div id="mensagens"></div>

    <div class="secao">
        <h2>Insight financeiro da semana</h2>
        <p id="insightTexto">Carregando insight...</p>
    </div>

    <!-- CARDS RESUMO -->
    <div class="secao">
        <h2>Resumo Geral</h2>
        <p>Aqui você vê um resumo rápido das suas receitas, despesas e saldo.</p>

        <div class="cards">
            <div class="card receita">
                <h3>Receitas</h3>
                <div class="valor" id="totalReceitas">R$ 0,00</div>
            </div>
            <div class="card despesa">
                <h3>Despesas</h3>
                <div class="valor" id="totalDespesas">R$ 0,00</div>
            </div>
            <div class="card saldo">
                <h3>Saldo</h3>
                <div class="valor" id="saldo">R$ 0,00</div>
            </div>
        </div>
    </div>

    <!-- GRÁFICO -->
    <div class="secao" id="graficoWrapper">
        <h2>Gráfico de Transações</h2>
        <p>Visualização de todas as receitas e despesas já registradas.</p>
        <canvas id="graficoTransacoes" height="120"></canvas>
    </div>

    <!-- ULTIMAS TRANSACOES -->
    <div class="secao">
        <h2>Últimas transações</h2>
        <p>As 5 transações mais recentes registradas.</p>
        <div id="areaUltimas">Carregando...</div>
    </div>

    <!-- LINKS DE AÇÃO -->
    <div class="secao">
        <h2>Ações rápidas</h2>
        <ul>
            <li><a href="registrar_transacao.html">Registrar Receita/Despesa</a></li>
            <li><a href="transacao_listagem.html">Visualizar Todas as Transações</a></li>
        </ul>
    </div>

</div>

<script>
    // Mapeia códigos de categoria (caso use) para nomes bonitos (opcional)
    const categoriaLabels = {
        SALARIO: "Salário",
        INVESTIMENTOS: "Investimentos",
        ALIMENTACAO: "Alimentação",
        TRANSPORTE: "Transporte",
        MORADIA: "Moradia",
        LAZER: "Lazer",
        OUTROS: "Outros"
    };

    // 1. Nome do usuário pela URL
    const params = new URLSearchParams(window.location.search);
    const nomeParam = params.get("usuario");
    const spanNome = document.getElementById("nomeUsuario");

    if (nomeParam) {
        spanNome.textContent = decodeURIComponent(nomeParam);
    }

    // 2. Mensagens
    const msgDiv = document.getElementById("mensagens");
    if (params.get("sucesso")) {
        msgDiv.innerHTML =
            "<p class='message-success'>" +
            decodeURIComponent(params.get("sucesso")) +
            "</p>";
    } else if (params.get("erro")) {
        msgDiv.innerHTML =
            "<p class='message-error'>" +
            decodeURIComponent(params.get("erro")) +
            "</p>";
    }

    // 3. Buscar transações e montar dashboard + insight + gráfico
    fetch("transacao?action=list")
        .then(resp => {
            if (!resp.ok) {
                throw new Error("HTTP " + resp.status);
            }
            return resp.json();
        })
        .then(lista => {
            if (!lista || lista.length === 0) {
                document.getElementById("areaUltimas").innerHTML =
                    "<p>Você ainda não tem transações. " +
                    "<a href='registrar_transacao.html'>Comece registrando a primeira!</a></p>";
                document.getElementById("insightTexto").textContent =
                    "Ainda não há transações suficientes para gerar um insight.";
                return;
            }

            // ---- calcular resumo ----
            let totalReceitas = 0;
            let totalDespesas = 0;

            lista.forEach(t => {
                const valor = Number(t.valor || 0);
                if (t.tipo === "RECEITA") {
                    totalReceitas += valor;
                } else if (t.tipo === "DESPESA") {
                    totalDespesas += valor;
                }
            });

            const saldo = totalReceitas - totalDespesas;

            const formatCurrency = valor =>
                valor.toLocaleString("pt-BR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

            document.getElementById("totalReceitas").textContent = "R$ " + formatCurrency(totalReceitas);
            document.getElementById("totalDespesas").textContent = "R$ " + formatCurrency(totalDespesas);
            document.getElementById("saldo").textContent = "R$ " + formatCurrency(saldo);


            const insight = gerarInsightSemanal(lista);
            document.getElementById("insightTexto").innerHTML = insight;

            // ---- últimas 5 transações ----
            const ultimas = lista.slice(0, 5);

            let htmlUltimas = `
                <table class="tabela-transacoes">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Categoria</th>
                            <th>Descrição</th>
                            <th style="text-align:right;">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            ultimas.forEach(t => {
                const classe = t.tipo === "RECEITA" ? "receita-texto" : "despesa-texto";

                const dataFormatada =
                    t.data ? new Date(t.data).toLocaleDateString("pt-BR") : "";

                const valor = Number(t.valor || 0);
                const valorFormatado = valor.toLocaleString("pt-BR", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                // Usa nome bonito da categoria se tiver no mapa
                const categoriaBonita = categoriaLabels[t.categoria] || t.categoria;

                htmlUltimas += `
                    <tr>
                        <td>${dataFormatada}</td>
                        <td class="${classe}">${t.tipo}</td>
                        <td>${categoriaBonita}</td>
                        <td>${t.descricao || ""}</td>
                        <td style="text-align:right;">R$ ${valorFormatado}</td>
                    </tr>
                `;
            });

            htmlUltimas += "</tbody></table>";

            document.getElementById("areaUltimas").innerHTML = htmlUltimas;

            // ---- gráfico (mantém igual ao seu, agregado por dia/tipo) ----
            const mapaPorData = {};

            lista.forEach(t => {
                const dataKey = t.data || "";
                if (!dataKey) return;

                if (!mapaPorData[dataKey]) {
                    mapaPorData[dataKey] = { receita: 0, despesa: 0 };
                }
                const valor = Number(t.valor || 0);
                if (t.tipo === "RECEITA") {
                    mapaPorData[dataKey].receita += valor;
                } else if (t.tipo === "DESPESA") {
                    mapaPorData[dataKey].despesa += valor;
                }
            });

            const datasOrdenadas = Object.keys(mapaPorData).sort();

            const labels = datasOrdenadas.map(d =>
                new Date(d).toLocaleDateString("pt-BR")
            );
            const dadosReceitas = datasOrdenadas.map(d => mapaPorData[d].receita);
            const dadosDespesas = datasOrdenadas.map(d => mapaPorData[d].despesa);

            const ctx = document.getElementById("graficoTransacoes").getContext("2d");
            new Chart(ctx, {
                type: "bar",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: "Receitas",
                            data: dadosReceitas,
                            backgroundColor: "rgba(0, 121, 107, 0.7)"
                        },
                        {
                            label: "Despesas",
                            data: dadosDespesas,
                            backgroundColor: "rgba(211, 47, 47, 0.7)"
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return "R$ " + value.toLocaleString("pt-BR");
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {
            console.error("Erro ao carregar transações para o dashboard:", err);
            document.getElementById("areaUltimas").innerHTML =
                "<p class='message-error'>Não foi possível carregar o resumo agora.</p>";
            document.getElementById("insightTexto").textContent =
                "Não foi possível calcular o insight esta semana.";
        });

    // ==============================
    // Função que calcula o INSIGHT SEMANAL
    // ==============================
    function gerarInsightSemanal(lista) {
        if (!lista || lista.length === 0) {
            return "Ainda não há transações suficientes para gerar um insight.";
        }

        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        // Descobrir a segunda-feira da semana atual
        const inicioSemanaAtual = new Date(hoje);
        const diaSemana = hoje.getDay(); // 0=Domingo, 1=Segunda...
        const diffSegunda = (diaSemana === 0 ? -6 : 1 - diaSemana);
        inicioSemanaAtual.setDate(inicioSemanaAtual.getDate() + diffSegunda);

        const fimSemanaAtual = new Date(inicioSemanaAtual);
        fimSemanaAtual.setDate(fimSemanaAtual.getDate() + 6); // domingo

        // Semana anterior
        const inicioSemanaAnterior = new Date(inicioSemanaAtual);
        inicioSemanaAnterior.setDate(inicioSemanaAnterior.getDate() - 7);

        const fimSemanaAnterior = new Date(inicioSemanaAtual);
        fimSemanaAnterior.setDate(fimSemanaAnterior.getDate() - 1);

        const totaisAtual = {};
        const totaisAnterior = {};
        let totalDespAtual = 0;
        let totalDespAnterior = 0;

        lista.forEach(t => {
            // Só despesas para o insight
            if (t.tipo !== "DESPESA" || !t.data) return;

            const d = new Date(t.data);
            d.setHours(0, 0, 0, 0);
            const valor = Number(t.valor || 0);
            const cat = t.categoria;

            if (d >= inicioSemanaAtual && d <= fimSemanaAtual) {
                totaisAtual[cat] = (totaisAtual[cat] || 0) + valor;
                totalDespAtual += valor;
            } else if (d >= inicioSemanaAnterior && d <= fimSemanaAnterior) {
                totaisAnterior[cat] = (totaisAnterior[cat] || 0) + valor;
                totalDespAnterior += valor;
            }
        });

        if (totalDespAtual === 0 && totalDespAnterior === 0) {
            return "Ainda não há despesas nas duas últimas semanas para gerar um insight.";
        }

        // Categoria com maior aumento de valor absoluto
        let categoriaDestaque = null;
        let deltaMax = 0;
        let valorAtualCat = 0;
        let valorAnteriorCat = 0;

        Object.keys(totaisAtual).forEach(cat => {
            const atual = totaisAtual[cat] || 0;
            const anterior = totaisAnterior[cat] || 0;
            const delta = atual - anterior;
            if (delta > deltaMax) {
                deltaMax = delta;
                categoriaDestaque = cat;
                valorAtualCat = atual;
                valorAnteriorCat = anterior;
            }
        });

        const formatCurrency = valor =>
            valor.toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

        let textoCategoria = "";
        if (categoriaDestaque && deltaMax > 0) {
            const nomeCategoria =
                categoriaLabels[categoriaDestaque] || categoriaDestaque;

            if (valorAnteriorCat <= 0.01) {
                textoCategoria =
                    `Sua categoria que mais cresceu foi <strong>${nomeCategoria}</strong> ` +
                    `com gastos de <strong>R$ ${formatCurrency(valorAtualCat)}</strong> ` +
                    `— praticamente um novo tipo de despesa em relação à semana anterior.`;
            } else {
                const perc = (deltaMax / valorAnteriorCat) * 100;
                textoCategoria =
                    `Sua categoria que mais cresceu foi <strong>${nomeCategoria}</strong>, ` +
                    `com gastos de <strong>R$ ${formatCurrency(valorAtualCat)}</strong> ` +
                    `(${perc.toFixed(1)}% a mais que na semana passada).`;
            }
        }

        let textoTotal = "";
        if (totalDespAnterior > 0 && totalDespAtual > 0) {
            const diffTotal = totalDespAtual - totalDespAnterior;
            const percTotal = (Math.abs(diffTotal) / totalDespAnterior) * 100;
            const direcao = diffTotal > 0 ? "aumentaram" : "diminuíram";

            textoTotal =
                ` No total, suas despesas da semana ${direcao} ` +
                `<strong>${percTotal.toFixed(1)}%</strong> ` +
                `em relação à semana anterior (de R$ ${formatCurrency(totalDespAnterior)} ` +
                `para R$ ${formatCurrency(totalDespAtual)}).`;
        } else if (totalDespAnterior === 0 && totalDespAtual > 0) {
            textoTotal =
                ` Esta foi a sua primeira semana com despesas registradas ` +
                `no sistema: você gastou <strong>R$ ${formatCurrency(totalDespAtual)}</strong>.`;
        } else if (totalDespAnterior > 0 && totalDespAtual === 0) {
            textoTotal =
                ` Você não registrou despesas nesta semana, ` +
                `mas teve gastos de <strong>R$ ${formatCurrency(totalDespAnterior)}</strong> ` +
                `na semana anterior.`;
        }

        return "Insight da semana: " + (textoCategoria || "") + textoTotal;
    }
</script>

</body>
</html>
